{"version":3,"file":"tar.js","names":["_utils","require","_header","blockSize","headerLength","inputLength","recordSize","Tar","constructor","recordsPerBlock","_defineProperty2","default","written","out","clean","blocks","length","save","bind","clear","append","filepath","input","opts","checksum","stringToUint8","Uint8Array","prototype","errorInputMatch","exec","toString","errorInput","errorMessage","concat","mode","parseInt","mtime","Math","floor","Number","Date","uid","gid","data","fileName","fileMode","pad","fileSize","type","ustar","owner","group","Object","keys","forEach","key","i","value","charCodeAt","headerArr","format","ceil","push","header","buffers","chunks","Array","max","pow","chunk","b","arguments","undefined","c","buffer","set","Blob","_default","exports"],"sources":["../../../../src/lib/tar/tar.ts"],"sourcesContent":["// This file is derived from the tar-js code base under MIT license\n// See https://github.com/beatgammit/tar-js/blob/master/LICENSE\n/*\n * tar-js\n * MIT (c) 2011 T. Jameson Little\n */\n\nimport {clean, pad, stringToUint8} from './utils';\nimport {format} from './header';\nimport type {TarBlocks, TarOptions, TarChunks, TarChunk} from './types';\n\nlet blockSize: number;\nlet headerLength: number;\nlet inputLength: number;\n\nconst recordSize = 512;\n\nclass Tar {\n  written: number;\n  out: Uint8Array;\n  blocks: TarBlocks = [];\n  length: number;\n\n  /**\n   * @param [recordsPerBlock]\n   */\n  constructor(recordsPerBlock: number | undefined) {\n    this.written = 0;\n    blockSize = (recordsPerBlock || 20) * recordSize;\n    this.out = clean(blockSize);\n\n    this.blocks = [];\n    this.length = 0;\n    this.save = this.save.bind(this);\n    this.clear = this.clear.bind(this);\n    this.append = this.append.bind(this);\n  }\n\n  /**\n   * Append a file to the tar archive\n   * @param filepath\n   * @param input\n   * @param [opts]\n   */\n  // eslint-disable-next-line complexity\n  append(filepath: string, input: string | Uint8Array, opts?: TarOptions | undefined) {\n    let checksum: string | any;\n\n    if (typeof input === 'string') {\n      input = stringToUint8(input);\n    } else if (input.constructor && input.constructor !== Uint8Array.prototype.constructor) {\n      // @ts-ignore\n      const errorInputMatch = /function\\s*([$A-Za-z_][0-9A-Za-z_]*)\\s*\\(/.exec(\n        input.constructor.toString()\n      );\n      const errorInput = errorInputMatch && errorInputMatch[1];\n      const errorMessage = `Invalid input type. You gave me: ${errorInput}`;\n      throw errorMessage;\n    }\n\n    opts = opts || {};\n\n    const mode = opts.mode || parseInt('777', 8) & 0xfff;\n    const mtime = opts.mtime || Math.floor(Number(new Date()) / 1000);\n    const uid = opts.uid || 0;\n    const gid = opts.gid || 0;\n\n    const data: Record<string, string> = {\n      fileName: filepath,\n      fileMode: pad(mode, 7),\n      uid: pad(uid, 7),\n      gid: pad(gid, 7),\n      fileSize: pad(input.length, 11),\n      mtime: pad(mtime, 11),\n      checksum: '        ',\n      // 0 = just a file\n      type: '0',\n      ustar: 'ustar  ',\n      owner: opts.owner || '',\n      group: opts.group || ''\n    };\n\n    // calculate the checksum\n    checksum = 0;\n    Object.keys(data).forEach((key) => {\n      let i: number;\n      const value = data[key];\n      let length: number;\n\n      for (i = 0, length = value.length; i < length; i += 1) {\n        checksum += value.charCodeAt(i);\n      }\n    });\n\n    data.checksum = `${pad(checksum, 6)}\\u0000 `;\n\n    const headerArr = format(data);\n\n    headerLength = Math.ceil(headerArr.length / recordSize) * recordSize;\n    inputLength = Math.ceil(input.length / recordSize) * recordSize;\n\n    this.blocks.push({\n      header: headerArr,\n      input,\n      headerLength,\n      inputLength\n    });\n  }\n  /**\n   * Compiling data to a Blob object\n   * @returns {Blob}\n   */\n  save(): Blob {\n    const buffers: any = [];\n    const chunks = new Array<TarChunks>();\n    let length = 0;\n    const max = Math.pow(2, 20);\n\n    let chunk = new Array<TarChunk>();\n    this.blocks.forEach((b: any = []) => {\n      if (length + b.headerLength + b.inputLength > max) {\n        chunks.push({blocks: chunk, length});\n        chunk = [];\n        length = 0;\n      }\n      chunk.push(b);\n      length += b.headerLength + b.inputLength;\n    });\n    chunks.push({blocks: chunk, length});\n\n    chunks.forEach((c: any = []) => {\n      const buffer = new Uint8Array(c.length);\n      let written = 0;\n      c.blocks.forEach((b: any = []) => {\n        buffer.set(b.header, written);\n        written += b.headerLength;\n        buffer.set(b.input, written);\n        written += b.inputLength;\n      });\n      buffers.push(buffer);\n    });\n\n    buffers.push(new Uint8Array(2 * recordSize));\n\n    return new Blob(buffers, {type: 'octet/stream'});\n  }\n  /**\n   * Clear the data by its blocksize\n   */\n  clear() {\n    this.written = 0;\n    this.out = clean(blockSize);\n  }\n}\n\nexport default Tar;\n"],"mappings":"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"}